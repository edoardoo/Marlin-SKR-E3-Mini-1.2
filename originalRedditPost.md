I've gotten my SKR E3 Mini v1.2 working with all the sweet TMC2209 features I was looking for. Swapping over the board was relatively straightforward, but the firmware side of things was not so much. One of the issues I saw was that a lot of early adopters who received this board got the 1.0 version, which had some issued that got ironed out with 1.2. Some of the guides and firmware floating around were not helpful for the 1.2 version and cause some confusion. Also I think that BigTreeTech's official fork of Marlin is very basic and is not configured to leverage this board well.\n\nSome of the problems I was seeing was that this firmware after compiling with BTT's official fork was too large to flash with all the sweet TMC2209 features enabled as this board only has 256KB of memory with 28KB reserved for EEPROM, so 228KB of usable space for firmware. I was also seeing conflicting information on how to set up serial ports (causing `TMC CONNECTION ERRORS`), or wiring for Sensorless Homing or BLTouch. I think some of that conflicting information stems from people with the 1.0 board.\n\nIf you order this board today, you **will** get the 1.2 version, so I thought it would be helpful to have a somewhat thorough/definitive guide out there. It really is a great board, especially for the price. Availability is becoming good now, but the install and setup feels sub-par, so I hope this guide will fix that.\n\n---\n\nHere is my own fork of Marlin official configured for this board:\n\n* https://github.com/morningreis/Marlin-SKR-E3-Mini-1.2\n\nThis comes configured as *I personally* want it with the following features:\n\n* BLTouch (tweaked for faster probing)\n* Sensorless Homing\n* S-Curve Acceleration\n* SD Card Support\n* StealthChop\n* Hybrid Threshold\n* Improved Buffer sizes\n* M122 Command / TMC_DEBUG\n\n(26NOV19)\n\n* 512K ROM support \n* M486 Cancel Object\n\n\nFeatures not enabled, but can be:\n\n* Linear Advance\n* M503\n\n---\n\n###BLTouch\n\nThe firmware is already configured for BLTouch but you must define your own nozzle offsets. I've included a [wiring diagram on GitHub](https://raw.githubusercontent.com/morningreis/Marlin-SKR-E3-Mini-1.2/bugfix-2.0.x/SKR_E3_Mini_1.2_wiring.png) on how to properly wire the BLTouch.\n\nIn `configuration.h`:\n\n    #define NOZZLE_TO_PROBE_OFFSET { X, Y, Z }\n\nIf you want to **disable** BLTouch, comment out `#define BLTOUCH` and `#define AUTO_BED_LEVELING_BILINEAR` in `configuration.h`, and comment out `#define BABYSTEP_ZPROBE_OFFSET` in `configuration_adv.h`\n\n###Sensorless Homing\n\nThe firmware is already configured for Sensorless Homing, the only thing you need to do is make sure to run a jumper wire, one for the X axis and one for the Y axis from the `DIAG` pin to `PC0` (for X) or `PC1` (for Y) [as shown in this diagram](https://raw.githubusercontent.com/morningreis/Marlin-SKR-E3-Mini-1.2/bugfix-2.0.x/SKR_E3_Mini_1.2_wiring.png). The default sensitivity is set to 5, but you can set this on your printer with the LCD menu. \n\n**NOTE 1** if you're coming from a TMC2130 or another driver, you can't use the same sensitivity values because they're on a different scale. The 2209 has 0 as least sensitive and 255 as most sensitive, and the 2130 has -64 as most sensitive and 63 as least sensitive.\n\n~~**NOTE 2** Sensorless Homing will *always* run in SpreadCycle (loud). This is by design, it is not a bug.~~ No longer true\n\nIf you want to **disable** Sensorless Homing, comment out `#define SENSORLESS_HOMING` in `configuration_adv.h`\n\n###S-Curve Acceleration\n\nI don't see any good reason to disable this, unless you're doing something really experimental, or need to free up some space for compilation. It smoothly accelerates your toolhead to reduce vibrations. There is nothing to configure for this.\n\nIf you want to **disable** this, comment out `#S_CURVE_ACCELERATION` in `configuration.h`\n\n###Stealthchop\n\nThese make your printer quiet, which is the whole point of getting a board with these drivers, but you can disable it if you hate yourself by commenting out:\n\n    #define STEALTHCHOP_XY\n    #define STEALTHCHOP_Z\n    #define STEALTHCHOP_E\n\n###Hybrid Threshold\n\nA better solution to disabling StealthChop altogether if you need extra torque is to use Hybrid Threshold. You can set a speed in mm/s at which your drivers will switch from StealthChop (quiet) to SpreadCycle (loud, but more torque).\n\nYou can **disable** Hybrid Threshold by commenting out `#define HYBRID_THRESHOLD` in `configuration_adv.h`\n\n###Linear Advance\n\nI have disabled this by default because I have an Ender 3 with a Bowden system. This feature is better for direct drive systems.\n\nIf you want to **enable** Linear Advance, uncomment `#define LIN_ADVANCE` in `configuration_adv.h`. [You will then need to figure out your K-Factor](http://marlinfw.org/tools/lin_advance/k-factor.html)\n\n[Teaching Tech has a really good video on how to do this](https://www.youtube.com/watch?v=n3yK0lJ8TWM)\n\n###M122\n\nM122 / TMC_DEBUG can now be enabled without disablibg anything else since memory is no longer an issue with 512KB, although I have left it disabled for production as Marlin suggests. \n\n~~The M122 command is useful if you're connected to your printer via a computer and want to troubleshoot, debug, or get diagnostics on your printer. It requires `#define TMC_DEBUG` to be uncommented however and this takes up a *lot* of space on the firmware. If you enable `TMC_DEBUG` without turning off some other features, it won't compile because of the 228KB ROM limitation, unless you override that (but I don't recommend you do this)~~\n\n---\n\n#Checklist of things YOU must tune for your printer\n\nIn `configuration.h`\n\n* `NOZZLE_TO_PROBE_OFFSET { X, Y, Z }` for BLTouch (Z-Probe offset can also be adjusted from your printer, and it must always be negative, [can also be set with M851](http://marlinfw.org/docs/gcode/M851.html))\n* E-steps under `#DEFAULT_AXIS_STEPS_PER_UNIT {X, Y, Z, **E** }` ([can also be set with M92](http://marlinfw.org/docs/gcode/M092.html))\n* PID Autotune\n* Preheat Constants - not required, but very convenient option to have\n\nIn `configuration_adv.h`\n\n* Vrefs under ` X_CURRENT`, ` Y_CURRENT`, ` Z_CURRENT`, ` E0_CURRENT` ([can also be set with M906](http://marlinfw.org/docs/gcode/M906.html))\n* K-Factor for Linear Advance ([can also be set with M900](http://marlinfw.org/docs/gcode/M900.html))\n* Sensorless Homing sensitivities (can be set through LCD: `Configuration&gt;Advanced&gt;TMC Drivers&gt; Sensorless Homing`)\n\n---\n\n#Compiling\n\nI used [VSCode](https://code.visualstudio.com/) with the PlatformIO extension. Once PlatformIO is installed, all you need to do is clone the fork from GitHub (or just download a .zip file) and open the folder with `platformio.ini` in it. Hit `Crtl+Alt+B` to build, and your firmware file will be in `Marlin/.pio/build/STM32F103RC_bigtree/firmware.bin`\n\n#Flashing\n\nPlace firmware.bin onto your SD card, put the card in your printer, turn your printer on. That's it!\n\n---\n\n###References\n\n[I followed this guide for the SKR 1.3 to enable a bunch of neat Marlin options](https://www.deviousweb.com/2019/08/28/skr1-3-tmc2209-and-bltouch-with-direct-drive)\n\n[Teaching Tech's video on the SKR E3 Mini is *very* helpful for the *hardware* install](https://www.youtube.com/watch?v=-XUQKQnUNig) however, note that he has a 1.0 board, and the wiring for the BLTouch servo is in a different order than it needs to be for the v1.2 board.\n\n---\n\nHope this helps, sensorless homies\n\n#UPDATE 26 NOV 19:\n\n* I've updated Marlin to the latest version and compiled with the most current version of PlatformIO. There was a strange issue where PIO 4.10 would cause the LCD to stay blank, even though the firmware would flash just fine causing the printer to be unusable\n\n* I've incorporated the 512K mod since I haven't seen any cases of this not working. Although you really do need to enable basically every feature before you exhaust even the 228K available by default. Thanks to /u/steenerson and /u/yuchen_ting on this\n\n* Sensorless Homing not seems to run just fine in StealthChop, so it will home quietly which a few people had complaints with. I also set Sensorless Homing defaults to something less aggressive since that was also an issue for some.\n\n* M486 for Object Cancellations enabled. This should be useful in conjunction with OctoPrint plugins to only partially cancel a print if a piece has failed, but the rest is good\n\n* There is a bug that has remained with this board since release where after a successful flash and creation of the `FIRMWARE.CUR` file, it does not remove `firmware.bin`. This just means your board is going to flash every time you turn it on. EEPROM settings will still be retained, it just means that it will take longer to turn on than it should. You can manually delete `firmware.bin` after it is flashed to avoid this\n\n* Sorry this took a while to update, but thanks for everyone's feedback!\n\n#UPDATE 18 DEC 19\n\n* ~~Seeing some bed heating failures after the last update enabling 512KB support. I am not sure if this is the issue, and I haven't been able to test, but here is how to revert back to 256KB:~~\n\nNo reported issues with 512KB as of 05 JAN 2020. It's enabled by default, but here is how you can disable it if you wish, or want to adapt this firmware for a different board.\n\n### Disable 512KB support\n\n~~Delete the line `board_upload.maximum_size = 524288` in platformio.ini and change `STM32_FLASH_SIZE` to `256` in `buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py`~~\n\nAs of 09 FEB 2020, you only need to select between `STM32F103RC_bigtree` or `STM32F103RC_bigtree_512K` in `platformio.ini` now on line 21 `default_envs`\n\n#UPDATE 27 DEC 19\n\n`PIDTEMPBED` disabled in `configuration.h` as I suspected this of causing print beds to heat improperly in some printers and trip thermal runaway protection. I think this will fix the issue, but it needs more testing. Any feedback is helpful.\n\n#UPDATE 05 JAN 20\n\nI'm back in country and have been able to verify myself the bed heating issue. It is safe to re-enable `PIDTEMPBED` in `configuration.h`. The first thing you should do after enabling it however is a PID autotune on your bed to get some good values using the following commands entered into the terminal. If you don't do that, then the bed doesn't heat up in a timely manner, and then thermal runaway protection thinks there is a problem and triggers.\n\nHeat the bed to 60C for 10 cycles. Set `Sxx` to whatever temperature you print at most frequently.\n\n    M303 E-1 S60 C10\n\nAfter this completes, set bed PID values\n\n    M304 Pxx.xx Ixx.xx Dxx.xx\n\n\nAlternatively, you can automatically use these results from the M303 by adding a `U1` to the end (thanks /u/hpapagaj)\n\n    M303 E-1 S60 C10 U1\n\nSave\n\n    M500\n\n\nYou can also put these values into `configuration.h` (lines 532-534) so you don't have to do this again if you recompile the firmware.\n\nAdditionally, Marlin 2.0.1 is out. I will be making a new branch of this firmware using that since it has some relevant fixes and features incorporated into it. I'll try to get that out in the coming week.\n\n#UPDATE 09 FEB 20\n\nNothing new to update feature wise, I just wanted to say that I'm still here and haven't abandoned this project in any way.\n\nIn my last update I mentioned Marlin 2.0.1 and updating to that... I'm going to hold off of that for now. People consistently post in this thread with issues they are having and as of the previous update, there have been very few reports of problems with the firmware. I don't want to move away from a stable build unless it is really worth it. Also Marlin is a very general purpose firmware designed for many, many different types of hardware. While it gets updates and fixes routinely, a lot of it doesn't apply to this board and printer. If there is some feature that you thing is worthwhile, **please** let me know and/or tag me in a post - I would love to hear about it. You can contact me through Github also, or even create a pull request.\n\n#UPDATE 09 FEB 20 #2\n\nJust a few minutes after I wrote that update I was alerted to a feature that may be handy for this board (thanks /u/RuairiSpain!). Expect an updated repo either later today or tomorrow. I am just testing this right now, but  the entire branch will be updated to the most current version of the bugfix-2.0.x branch with CoolStep enabled, leveraging a useful feature of the TMC2209 drivers. CoolStep will help keep drivers significantly cooler. You can [learn more about CoolStep here](https://www.youtube.com/watch?v=Prw7wNa20Gk), but what this means for you is that you need not fuss too much about setting the motor current (or as I called it earlier the 'Vrefs'). Since CoolStep decreases current if there is no resistance, so it's fine to set the motor current slightly on the high side. It will have all the power it needs - when it needs it - without making everything overheat.\n\nThis version also involves a better integration of the 512K version of the firmware, so switching back and forth between that and 256K will be much easier, although I will keep 512K as the default since nobody has reported any issues with it yet.\n\n~~EDIT: Changes are tested and live now~~\n\n#UPDATE 14 FEB 20\n\nRemoving CoolStep for now since it was removed from the main bugfix branch (or should not have been added to it). I will re-add it when able.\n\n###\"My printer is noisy in the X/Y/Z axis! Help me!\"\n\n\nI'm not answering these questions anymore. As I explained earlier in this post, because of Hybrid Threshold, your printer will revert to SpreadCyle (loud) to ensure that it does not skip steps in very fast moves. It goes back to StealthChop (quiet) at any moves beyond this speed threshold. I've already explained how to disable Hybrid Threshold. You can also edit the speeds in the same area, but I don't recommend it. This is a feature, not a bug. You can disable it if you wish, but it's on you if you get skipped steps and layer shifts.\n\nAgain, I AM NOT answering these questions any longer. I have put a lot of effort into putting this guide together and working out all the bugs/quirks/settings of Marlin. The least you can do if you have an issue is read this guide before posting a question like that. Thank you.\n\nPlease use the Default 2.0.x branch as it is much more stable. The bugfix branch is not guaranteed to work correctly.
